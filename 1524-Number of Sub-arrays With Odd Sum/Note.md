# 1524. Number of Sub-arrays With Odd Sum

Given an array of integers `arr`, return the number of subarrays with an odd sum.

Since the answer can be very large, return it modulo `10^9 + 7`.

**Constraints:**

- `1 <= arr.length <= 10^5`
- `1 <= arr[i] <= 100`

## 基礎思路

本題要求計算陣列中所有和為奇數的子陣列數量。
這裡可以巧妙地運用 **前綴和（prefix sum）以及奇偶性（parity）** 的基本性質，達到高效計算。

### 數學證明

為了更好地理解這個問題，以下是背後的數學證明。

#### 1. 前綴和的定義與性質

令

$$
S[i] = \sum_{k=0}^{i} a_k,\quad i=0,1,2,\ldots,n-1
$$

其中 $a_k$ 為陣列中的元素，並定義 $S[0]=a_0$。為了便於分析，我們通常還引入一個初始前綴和  

$$
S[-1] = 0,
$$

它自然為偶數。

對於任意子陣列，其起始位置為 $i$（可以為 0，即包含初始前綴 $S[-1]=0$）而結束位置為 $j$（$i \le j < n$），其和為：

$$
\text{sum}_{i,j} = S[j] - S[i-1].
$$

Note：當 $i=0$ 時，子陣列和即為 $S[j] - S[-1] = S[j]$。

#### 2. 奇偶性差分的基本觀察

根據數學中對奇偶數的基本性質：
- 偶數 $-$ 偶數 $=$ 偶數
- 奇數 $-$ 奇數 $=$ 偶數
- 奇數 $-$ 偶數 $=$ 奇數
- 偶數 $-$ 奇數 $=$ 奇數

因此，子陣列的和 $S[j] - S[i-1]$ 為奇數，當且僅當 $S[j]$ 與 $S[i-1]$ 的奇偶性不同。

#### 3. 進行計數

**（1）考慮以 $S[-1]=0$ 為起點的情形**

- 當子陣列從陣列開頭開始時，子陣列和為 $S[j]$。
- 若 $S[j]$ 為奇數，則這個子陣列和為奇數。
- 設 $O$ 為陣列中（不包括 $S[-1]$）所有奇數前綴和的個數，即 $\text{odd} = |O|$。

因此，從開頭開始的奇數子陣列數量就是 $\text{odd}$。

**（2）考慮不從開頭開始的情形**

對於任意一個子陣列，我們考慮其起始前綴 $S[i-1]$ 與終止前綴 $S[j]$（這裡 $i \ge 1$）。根據前述觀察，子陣列和為奇數當且僅當：

$$
\text{parity}(S[j]) \neq \text{parity}(S[i-1])
$$

若我們定義：
- $E'$：除去 $S[-1]$ 之外，所有偶數前綴和的集合，其數量為 $\text{even}$
- $O$：所有奇數前綴和的集合，其數量為 $\text{odd}$

那麼任取一個奇數前綴和和一個偶數前綴和（且它們在原序列中的位置滿足前者在前）的差，其結果必定為奇數。

Note：這裡我們實際上考慮的是所有 $(i-1, j)$ 的配對，其中 $S[i-1]$ 與 $S[j]$ 奇偶不同。

由於順序（即 $i-1 < j$）在計數上會導致較複雜的討論，我們可以採用等價的思路：  
如果我們把那個初始的 $S[-1]=0$（偶數）也考慮進來，則令  

$$
E = \text{even} + 1
$$

那麼所有子陣列（包括從開頭開始的）滿足和為奇數的配對數正好為

$$
\text{總數} = E \times \text{odd}
$$

由於 $E = \text{even} + 1$，因此

$$
E \times \text{odd} = \text{odd} + (\text{even} \times \text{odd})
$$

這正是程式碼這正是程式碼中返回的結果。

#### 4. 證明結論

我們利用前綴和的性質，將任一子陣列的和 $S[j]−S[i−1]$ 看作兩個前綴和之差，並利用奇偶性差分的規則，可以得出：

當其中一個前綴和是偶數、另一個是奇數時，差值為奇數。
將所有可能的配對（包含從初始 $S[−1]=0$ 到奇數前綴和以及其他情形）計數後，可得總數為 $odd+(even×odd)$。

## 解題步驟

### Step 1: 定義變數

```typescript
let odd = 0;  // 奇數前綴和的數量
let even = 0; // 偶數前綴和的數量
let sum = 0;  // 總和
```

### Step 2: 遍歷陣列

我們遍歷陣列，計算前綴和，並根據和的奇偶性更新 `odd` 和 `even` 變數。

```typescript
for (let i = 0; i < arr.length; i++) {
  // 計算前綴和
  sum += arr[i];
  if (sum % 2 === 0) {
    // 如果和為偶數，則偶數前綴和的數量加一
    even++;
  } else {
    // 如果和為奇數，則奇數前綴和的數量加一
    odd++;
  }
}
```

### Step 3: 計算結果

```typescript
return (odd + (even * odd)) % (10 ** 9 + 7);
```

## 時間複雜度

- 遍歷一次陣列，時間複雜度為 $O(n)$。
- 總時間複雜度為 $O(n)$。

> $O(n)$

## 空間複雜度

- 我們只使用了常數個變數，因此空間複雜度為 $O(1)$。
- 總空間複雜度為 $O(1)$。

> $O(1)$
